#!/bin/sh
MYSQLU=root
MYSQLP=root

if [ -n $1 ]; then
  if [ $1 = "--disable" ]; then
    disable=TRUE
    1="$2"
  fi
  if [ -n $1 ]; then
    projname="$1"
  fi
fi


if [ -z $projname ]; then
  echo "Available sites:"
  ls /etc/apache2/sites-available
elif [ -f /etc/apache2/sites-enabled/$projname ]; then
  if [ $disable ]; then
    echo "Disabling site $projname..."
    sudo a2dissite $projname
    sudo service apache2 reload
    return 0
  else
    echo "Site $1 is already enabled."
    return 0
  fi
elif [ -f /etc/apache2/sites-available/$projname ]; then
  echo "Enabling site $projname..."
  sudo a2ensite $projname
  sudo service apache2 reload
else
  echo "Setting up vhosts for site $projname..."
  sudo ln -s `pwd`/drupal /var/www/$projname
  sudo sed "s/PROJECTNAME/$projname/" < $DOTSDIR/conf/vhost | sudo tee /etc/apache2/sites-available/$projname
  echo "Enabling site $projname..."
  sudo a2ensite $projname
  sudo service apache2 reload
  echo "Configuring /etc/hosts..."
  echo "127.0.0.1 $projname.dev" > $DOTSDIR/conf/$projname.hosts
  cat /etc/hosts >> $DOTSDIR/conf/$projname.hosts
  sudo mv /etc/hosts /etc/hosts.backup
  sudo mv $DOTSDIR/conf/$projname.hosts /etc/hosts
  echo "Setting up database $projname..."
  mysql --user=$MYSQLU --password=$MYSQLP -e "CREATE DATABASE $projname"
  mysql --user=$MYSQLU --password=$MYSQLP -e "CREATE USER $projname IDENTIFIED BY '$projname'"
  mysql --user=$MYSQLU --password=$MYSQLP -e "GRANT ALL PRIVILEGES ON $projname.* TO '$projname'@'localhost' IDENTIFIED BY '$projname'"
  echo "Creating settings.local.php..."
  if [ ! -d shared ]; then
    echo "ERROR: No 'shared' directory!" 1>&2
    return 1
  fi
  sed "s/PROJECTNAME/$projname/" < $DOTSDIR/conf/default.settings.local.php > shared/settings.local.php
  echo "Setting up shell aliases..."
  echo "hash -d $projname=`pwd`" >> $DOTSDIR/lib/zsh/dirs.local
fi
